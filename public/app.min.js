"use strict";var app=angular.module("Scrbbl",["ngCookies","ngResource","ngMessages","ngRoute","mgcrea.ngStrap"]);app.config(["$locationProvider","$routeProvider",function(t,e){t.html5Mode(!0),e.when("/",{templateUrl:"public/views/home.html",controller:"MainCtrl"}).when("/manual",{templateUrl:"public/views/manual.html",controller:"ManualCtrl"}).when("/scrobblealbum",{templateUrl:"public/views/scrobblealbum.html",controller:"ScrobbleAlbumCtrl"}).when("/scrobbleradio",{templateUrl:"public/views/scrobbleradio.html",controller:"RadioCtrl"}).when("/scrobbleuser",{templaterUrl:"public/views/scrobbleuser.html",controller:"UserCtrl"}).otherwise({redirectTo:"/"})}]),function(){app.factory("Authenticate",["$http","$window","$location",function(t,e,n){function o(){var t=n.absUrl().split("?")[0];return e.location.href="http://www.last.fm/api/auth/?api_key=f4f831e3766b42660d26c9b29b25599e&cb="+t}function r(e){return t.get("/api/auth/"+e)}return{login:o,createSession:r}}])}(),function(){function t(t,e){}app.factory("lastfmUser",["$http","$q",t])}(),function(){app.factory("Radio",["$http","$window","$q",function(t,e,n){function o(e){return t.get("/api/radio/getstationplays/"+e).then(function(t){return t.data.recenttracks.track}).catch(function(t){n.reject("Error retrieving station plays - (HTTP Status: "+t.status+")")})}return{getStationPlays:o}}])}(),function(){app.factory("Scrobble",["$http","$window","$q","UserPersistence",function(t,e,n,o){function r(e){return t.post("/api/scrobble",e)}function a(e){return t.post("/api/searchalbum",e).then(function(t){var e=_.map(t.data.results,function(t){return{title:t.collectionName,artist:t.artistName,collectionId:t.collectionId,imageUrl:t.artworkUrl60}});return e}).catch(function(t){return n.reject("Error searching for albums - (HTTP Status: "+t.status+")")})}function c(e){return t({method:"POST",url:encodeURI("/api/scrobblealbum"),headers:{username:l.userName,key:l.key},data:e})}function i(t){}function s(){return t({method:"GET",url:encodeURI("api/getartistscrobbles"),headers:{username:l.userName,key:l.key}}).then(function(t){return t.data})}var l=o.getCookieData(),u={};return{scrobbleTrack:r,searchAlbum:a,scrobbleAlbum:c,getArtistScrobbles:i,getUserTopArtists:s,topArtists:u}}])}(),function(){app.factory("Track",["$http","$window","$q",function(t,e,n){function o(e){return t.get("/api/albums/getalbuminfo/"+e).then(function(t){return t.data}).catch(function(t){return n.reject("Error getting album tracks")})}return{getAlbumTracks:o}}])}(),function(){app.factory("UserPersistence",["$cookies",function(t){function e(e){a=e.username,c=e.key,t.put("userName",a),t.put("key",c)}function n(){var e={};return e.userName=t.get("userName"),e.key=t.get("key"),e.userName?e:null}function o(){a="",c="",t.remove("userName"),t.remove("key")}function r(){var e=null;return t.get("key")&&(e=t.get("key")),e}var a="",c="";return{setCookieData:e,getCookieData:n,clearCookieData:o,getCookieKey:r}}])}(),function(){app.controller("ScrobbleAlbumCtrl",["$scope","$alert","Authenticate","$location","Scrobble","UserPersistence","Track",function(t,e,n,o,r,a,c){t.album={},t.selectedAlbum=null,t.search=function(){r.searchAlbum(t.album).then(function(e){t.results=e}).catch(function(t){console.log(t)}).finally(function(){console.log("Complete")})},t.refreshForm=function(){t.success=!1,t.track={}},t.selectResult=function(e){t.selectedAlbum=e,c.getAlbumTracks(e.collectionId).then(function(e){t.album.tracks=e})},t.scrobbleAlbum=function(){t.album.user=a.getCookieData(),r.scrobbleAlbum(t.album).then(function(e){t.success=e,t.loading=!1,t.results={},t.selectedAlbum={},t.album={}})}}])}(),function(){app.controller("LoginCtrl",["$scope","$alert","Authenticate","$location","UserPersistence",function(t,e,n,o,r){r.getCookieData()&&(t.user=r.getCookieData());var a=o.search().token;a&&"undefined"!=a&&!r.getCookieData()&&n.createSession(a).then(function(e){t.user={},t.user.username=e.data.username,t.user.key=e.data.key,r.setCookieData(t.user)}),t.authenticate=function(){console.log("clicked"),n.login()},t.logout=function(){r.clearCookieData(),location.reload()}}])}(),function(){app.controller("MainCtrl",["$scope","$alert","Authenticate","$location","$cookies","UserPersistence",function(t,e,n,o,r,a){t.showFirstVisitMessage=!r.visited,r.visited="yes"}])}(),function(){app.controller("ManualCtrl",["$scope","$alert","Authenticate","$location","Scrobble","UserPersistence",function(t,e,n,o,r,a){a.getCookieData()&&r.getUserTopArtists().then(function(t){r.topArtists=t}),t.track={},t.success=!1,t.scrobble=function(){t.loading=!0,t.track.user=a.getCookieData(),r.scrobbleTrack(t.track).then(function(e){t.success=e,t.loading=!1})},t.refreshForm=function(){t.success=!1,t.track={}},t.$watch("track.songArtist",_.debounce(function(e,n){t.$apply(function(){void 0!==e&&(t.artistScrobbles=_.result(_.find(r.topArtists,function(t){return t.name.toLowerCase()===e.toLowerCase()}),"playcount"),console.log(t.artistScrobbles))})},1e3),!0),t.clearForm=function(){t.track={}}}])}(),function(){app.controller("RadioCtrl",["$scope","$alert","Authenticate","$location","Scrobble","Radio",function(t,e,n,o,r,a){t.stations=[{station:"Radio 1",lastfmName:"bbcradio1"},{station:"Radio 2",lastfmName:"bbcradio2"},{station:"Radio 3",lastfmName:"bbcradio3"},{station:"Radio 1xtra",lastfmName:"bbc1xtra"}],t.getStationPlays=function(){a.getStationPlays(t.selectedStation).then(function(e){t.results=_.map(e,function(t){return{title:t.name,artist:t.artist["#text"],date:t.date?t.date["#text"]:" "}})}).catch(function(t){console.log("Error message: "+t)})},t.scrobbleSelected=function(){var e={};e.tracks=_.chain(t.results).filter(function(t){return t.toScrobble}).map(function(t){return{artistName:t.artist,trackCensoredName:t.title,date:t.date}}).value(),r.scrobbleAlbum(e).then(function(e){t.success=e,t.loading=!1,t.results={},t.selectedAlbum={},t.album={}})}}])}();