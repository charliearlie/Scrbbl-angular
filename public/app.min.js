"use strict";var app=angular.module("Scrbbl",["ngCookies","ngResource","ngMessages","ngRoute","mgcrea.ngStrap"]);app.config(["$locationProvider","$routeProvider",function(t,e){t.html5Mode(!0),e.when("/",{templateUrl:"public/views/home.html",controller:"MainCtrl"}).when("/manual",{templateUrl:"public/views/manual.html",controller:"ManualCtrl"}).when("/scrobblealbum",{templateUrl:"public/views/scrobblealbum.html",controller:"ScrobbleAlbumCtrl"}).when("/scrobbleradio",{templateUrl:"public/views/scrobbleradio.html",controller:"RadioCtrl"}).when("/scrobbleuser",{templateUrl:"public/views/scrobbleuser.html",controller:"ScrobbleUserCtrl"}).otherwise({redirectTo:"/"})}]),function(){app.factory("Authenticate",["$http","$window","$location",function(t,e,n){function r(){var t=n.absUrl().split("?")[0];return e.location.href="http://www.last.fm/api/auth/?api_key=f4f831e3766b42660d26c9b29b25599e&cb="+t}function o(e){return t.get("/api/auth/"+e)}return{login:r,createSession:o}}])}(),function(){function t(t,e){function n(e){return t.get("/api/user/getuserplays/"+e).then(r).catch(o)}function r(t){return t.data.recenttracks.track}function o(t){console.log(t)}return{getUserData:n}}app.factory("LastfmUser",["$http","$q",t])}(),function(){app.factory("Radio",["$http","$window","$q",function(t,e,n){function r(e){return t.get("/api/user/getuserplays/"+e).then(function(t){return t.data.recenttracks.track}).catch(function(t){n.reject("Error retrieving station plays - (HTTP Status: "+t.status+")")})}return{getStationPlays:r}}])}(),function(){app.factory("Scrobble",["$http","$window","$q","UserPersistence",function(t,e,n,r){function o(e){return t.post("/api/scrobble",e)}function a(e){return t.post("/api/searchalbum",e).then(function(t){var e=_.map(t.data.results,function(t){return{title:t.collectionName,artist:t.artistName,collectionId:t.collectionId,imageUrl:t.artworkUrl60}});return e}).catch(function(t){return n.reject("Error searching for albums - (HTTP Status: "+t.status+")")})}function c(e){return t({method:"POST",url:encodeURI("/api/scrobblealbum"),headers:{username:u.userName,key:u.key},data:e})}function s(t){}function i(){return t({method:"GET",url:encodeURI("api/getartistscrobbles"),headers:{username:u.userName,key:u.key}}).then(function(t){return t.data})}var u=r.getCookieData(),l={};return{scrobbleTrack:o,searchAlbum:a,scrobbleAlbum:c,getArtistScrobbles:s,getUserTopArtists:i,topArtists:l}}])}(),function(){app.factory("Track",["$http","$window","$q",function(t,e,n){function r(e){return t.get("/api/albums/getalbuminfo/"+e).then(function(t){return t.data}).catch(function(t){return n.reject("Error getting album tracks")})}return{getAlbumTracks:r}}])}(),function(){app.factory("UserPersistence",["$cookies",function(t){function e(e){a=e.username,c=e.key,t.put("userName",a),t.put("key",c)}function n(){var e={};return e.userName=t.get("userName"),e.key=t.get("key"),e.userName?e:null}function r(){a="",c="",t.remove("userName"),t.remove("key")}function o(){var e=null;return t.get("key")&&(e=t.get("key")),e}var a="",c="";return{setCookieData:e,getCookieData:n,clearCookieData:r,getCookieKey:o}}])}(),function(){app.controller("ScrobbleAlbumCtrl",["$scope","$alert","Authenticate","$location","Scrobble","UserPersistence","Track",function(t,e,n,r,o,a,c){t.album={},t.selectedAlbum=null,t.search=function(){o.searchAlbum(t.album).then(function(e){t.results=e}).catch(function(t){console.log(t)}).finally(function(){console.log("Complete")})},t.refreshForm=function(){t.success=!1,t.track={}},t.selectResult=function(e){t.selectedAlbum=e,c.getAlbumTracks(e.collectionId).then(function(e){t.album.tracks=e})},t.scrobbleAlbum=function(){t.album.user=a.getCookieData(),o.scrobbleAlbum(t.album).then(function(e){t.success=e,t.loading=!1,t.results={},t.selectedAlbum={},t.album={}})}}])}(),function(){app.controller("LoginCtrl",["$scope","$alert","Authenticate","$location","UserPersistence",function(t,e,n,r,o){o.getCookieData()&&(t.user=o.getCookieData());var a=r.search().token;a&&"undefined"!=a&&!o.getCookieData()&&n.createSession(a).then(function(e){t.user={},t.user.username=e.data.username,t.user.key=e.data.key,o.setCookieData(t.user)}),t.authenticate=function(){console.log("clicked"),n.login()},t.logout=function(){o.clearCookieData(),location.reload()}}])}(),function(){app.controller("MainCtrl",["$scope","$alert","Authenticate","$location","$cookies","UserPersistence",function(t,e,n,r,o,a){t.showFirstVisitMessage=!o.visited,o.visited="yes"}])}(),function(){app.controller("ManualCtrl",["$scope","$alert","Authenticate","$location","Scrobble","UserPersistence",function(t,e,n,r,o,a){a.getCookieData()&&o.getUserTopArtists().then(function(t){o.topArtists=t}),t.track={},t.success=!1,t.scrobble=function(){t.loading=!0,t.track.user=a.getCookieData(),o.scrobbleTrack(t.track).then(function(e){t.success=e,t.loading=!1})},t.refreshForm=function(){t.success=!1,t.track={}},t.$watch("track.songArtist",_.debounce(function(e,n){t.$apply(function(){void 0!==e&&(t.artistScrobbles=_.result(_.find(o.topArtists,function(t){return t.name.toLowerCase()===e.toLowerCase()}),"playcount"),console.log(t.artistScrobbles))})},1e3),!0),t.clearForm=function(){t.track={}}}])}(),function(){app.controller("RadioCtrl",["$scope","$alert","Authenticate","$location","Scrobble","Radio",function(t,e,n,r,o,a){t.stations=[{station:"Radio 1",lastfmName:"bbcradio1"},{station:"Radio 2",lastfmName:"bbcradio2"},{station:"Radio 3",lastfmName:"bbcradio3"},{station:"Radio 1xtra",lastfmName:"bbc1xtra"}],t.getStationPlays=function(){a.getStationPlays(t.selectedStation).then(function(e){t.results=_.map(e,function(t){return{title:t.name,artist:t.artist["#text"],date:t.date?t.date["#text"]:" "}})}).catch(function(t){console.log("Error message: "+t)})},t.scrobbleSelected=function(){var e={};e.tracks=_.chain(t.results).filter(function(t){return t.toScrobble}).map(function(t){return{artistName:t.artist,trackCensoredName:t.title,date:t.date}}).value(),o.scrobbleAlbum(e).then(function(e){t.success=e,t.loading=!1,t.results={},t.selectedAlbum={},t.album={}})}}])}(),function(){app.controller("ScrobbleUserCtrl",["$scope","LastfmUser",function(t,e){t.lastfmuser={},t.searchUser=function(){e.getUserData(t.lastfmuser.name).then(function(e){t.results=_.map(e,function(t){return{title:t.name,artist:t.artist["#text"],date:t.date?t.date["#text"]:" "}})}).catch(function(t){})},t.$watch("userToSearch",_.debounce(function(e,n){t.$apply(function(){console.log(t.userToSearch)})},1e3),!0)}])}();